name: Biweekly Sync Exhibitions + Recommend

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */14 * *"  # รันทุก 14 วัน เวลา 00:00 UTC

jobs:
  sync-and-recommend:
    runs-on: ubuntu-latest

    env:
      MONGODB_URI: ${{ secrets.MONGO_URI }}

    steps:
      - name: 📦 เริ่มงาน Sync + Recommend
        run: echo "🚀 Starting biweekly sync and recommendation"

      - name: 🧱 Checkout data-files branch
        uses: actions/checkout@v3
        with:
          ref: data-files

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: 📦 Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🕷️ Run all upcoming spiders
        run: python run_all_upcoming.py
        continue-on-error: false  # หยุด workflow ทันทีถ้ามี error

      - name: 📝 Rename JSON files to hash
        run: python rename_json_to_hash.py

      - name: 🧠 Merge exhibition data
        run: python merge.py --mode=upcoming

      - name: ☁️ Upload merged data to MongoDB
        run: python upload_to_mongo.py

      - name: 💻 Checkout backend branch
        uses: actions/checkout@v3
        with:
          ref: backend
          path: backend-code

      - name: 🛠 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: 📦 Install backend dependencies
        run: |
          cd backend-code
          npm install

      - name: 🤖 Run recommend_cron.js
        run: |
          cd backend-code/cron
          node recommend_cron.js
