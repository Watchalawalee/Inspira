name: Biweekly Sync Exhibitions + Recommend

on:
  schedule:
    - cron: '0 0 */14 * *'  # ‡∏ó‡∏∏‡∏Å 14 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤ 00:00 UTC (07:00 ‡∏ô ‡πÑ‡∏ó‡∏¢)
  workflow_dispatch:

jobs:
  sync-and-recommend:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout data-files
      - name: Checkout data-files branch
        uses: actions/checkout@v3
        with:
          ref: data-files

      # 2Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: pip install pymongo dateparser requests

      # üßº 4Ô∏è‚É£ Rename JSON files to hash (‡πÉ‡∏´‡∏°‡πà)
      - name: Rename JSON files to hash
        run: python rename_json_to_hash.py

      # üß© 5Ô∏è‚É£ Run merge
      - name: Merge exhibition data
        run: python merge.py --mode upcoming

      # ‚¨ÜÔ∏è 6Ô∏è‚É£ Upload to MongoDB
      - name: Upload merged data to MongoDB
        run: python upload_to_mongo.py

      # 7Ô∏è‚É£ Checkout backend branch (‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå backend/)
      - name: Checkout backend branch
        uses: actions/checkout@v3
        with:
          ref: backend
          path: backend

      # 8Ô∏è‚É£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 9Ô∏è‚É£ Install backend dependencies
      - name: Install backend dependencies
        run: cd backend && npm install

      # üéØ üîÅ 10Ô∏è‚É£ Run recommend_cron.js
      - name: Run recommend_cron.js
        run: cd backend && node cron/recommend_cron.js
