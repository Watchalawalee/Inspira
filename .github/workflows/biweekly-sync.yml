name: Biweekly Sync Exhibitions + Recommend

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */14 * *"  # à¸£à¸±à¸™à¸—à¸¸à¸ 14 à¸§à¸±à¸™ à¹€à¸§à¸¥à¸² 00:00 UTC

jobs:
  sync-and-recommend:
    runs-on: ubuntu-latest

    env:
      MONGODB_URI: ${{ secrets.MONGO_URI }}

    steps:
      - name: ğŸ“¦ à¹€à¸£à¸´à¹ˆà¸¡à¸‡à¸²à¸™ Sync + Recommend
        run: echo "ğŸš€ Starting biweekly sync and recommendation"

      - name: ğŸ§± Checkout data-files branch
        uses: actions/checkout@v3
        with:
          ref: data-files

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ•·ï¸ Run all upcoming spiders
        run: python run_all_upcoming.py
        continue-on-error: false  # à¸«à¸¢à¸¸à¸” workflow à¸—à¸±à¸™à¸—à¸µà¸–à¹‰à¸²à¸¡à¸µ error

      - name: ğŸ“ Rename JSON files to hash
        run: python rename_json_to_hash.py

      - name: ğŸ§  Merge exhibition data
        run: python merge.py --mode=upcoming

      - name: â˜ï¸ Upload merged data to MongoDB
        run: python upload_to_mongo.py

      - name: ğŸ’» Checkout backend branch
        uses: actions/checkout@v3
        with:
          ref: backend
          path: backend-code

      - name: ğŸ›  Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend-code
          npm install

      - name: ğŸ¤– Run recommend_cron.js
        run: |
          cd backend-code/cron
          node recommend_cron.js
