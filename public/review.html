<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>รีวิวนิทรรศการ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="text-center">
    <button type="button" onclick="goBack()" class="mt-4 text-blue-600 hover:underline">
      ← ย้อนกลับไปหน้านิทรรศการ
    </button>
  </div>  

  <div class="max-w-xl mx-auto py-10 px-4">
    <h1 class="text-2xl font-bold mb-4 text-center">รีวิวนิทรรศการ</h1>
    <form id="reviewForm" class="bg-white p-6 rounded shadow space-y-4">
      <div>
        <label class="block font-semibold mb-1">ให้คะแนน:</label>
        <div id="stars" class="flex gap-1 text-2xl cursor-pointer">
          <span data-value="1">☆</span>
          <span data-value="2">☆</span>
          <span data-value="3">☆</span>
          <span data-value="4">☆</span>
          <span data-value="5">☆</span>
        </div>
      </div>
      <div>
        <label class="block font-semibold mb-1">แสดงความคิดเห็น:</label>
        <textarea id="reviewText" class="w-full border rounded p-2" rows="4" required></textarea>
      </div>
      <div>
        <label class="block font-semibold mb-1">อัปโหลดรูปภาพ ( ถ้ามี ):</label>
        <input type="file" id="image" accept="image/*">
        <img id="previewImage" class="mt-2 max-h-48 hidden" alt="รูปเดิม">
      </div>
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">ส่งรีวิว</button>
    </form>
  </div>

  <script>
    const stars = document.querySelectorAll("#stars span");
    let selectedRating = 0;
    let exhibitionId = null;
    let isEdit = false;
    let existingReviewId = null;

    stars.forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = parseInt(star.dataset.value);
        updateStars();
      });
    });

    function updateStars() {
      stars.forEach((s, i) => s.textContent = i < selectedRating ? "★" : "☆");
    }

    async function resolveExhibitionId(idParam) {
      try {
        const res = await fetch(`http://localhost:5000/exhibitions/${idParam}`);
        if (res.ok) {
          exhibitionId = idParam;
          return;
        }
      } catch {}

      try {
        const res = await fetch(`http://localhost:5000/reviews/id/${idParam}`);
        const review = await res.json();
        exhibitionId = review.exhibition_id._id || review.exhibition_id;
        selectedRating = review.rating;
        updateStars();
        document.getElementById("reviewText").value = review.review;
        existingReviewId = review._id;
        isEdit = true;
        if (review.image_url) {
          const img = document.getElementById("previewImage");
          img.src = `http://localhost:5000${review.image_url}`;
          img.classList.remove("hidden");
        }
      } catch (err) {
        console.error("Exhibition ID not found:", err);
        alert("ไม่พบข้อมูลนิทรรศการ");
      }
    }

    const idParam = new URLSearchParams(window.location.search).get("id");
    const token = localStorage.getItem("token");
    const userId = token ? JSON.parse(atob(token.split('.')[1])).id : null;

    resolveExhibitionId(idParam);

    document.getElementById("reviewForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!token) return alert("กรุณาเข้าสู่ระบบก่อน");
      if (!selectedRating) return alert("กรุณาให้คะแนน");

      const formData = new FormData();
      formData.append("exhibition_id", exhibitionId);
      formData.append("rating", selectedRating);
      formData.append("review", document.getElementById("reviewText").value);
      const imageInput = document.getElementById("image");
      if (imageInput.files.length > 0) {
        formData.append("image", imageInput.files[0]);
      }

      const url = isEdit 
        ? `http://localhost:5000/reviews/${existingReviewId}` 
        : "http://localhost:5000/reviews";
      const method = isEdit ? "PUT" : "POST";

      try {
        const res = await fetch(url, {
          method,
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (res.ok) {
          alert("✅ บันทึกรีวิวเรียบร้อยแล้ว");
          window.location.href = `exhibition.html?id=${exhibitionId}`;
        } else {
          alert("❌ ผิดพลาด: " + (data.message || data.error));
        }
      } catch (err) {
        console.error("Error submitting review:", err);
        alert("เกิดข้อผิดในการส่งรีวิว");
      }
    });

    function goBack() {
      window.location.href = `exhibition.html?id=${exhibitionId}`;
    }
  </script>
</body>
</html>