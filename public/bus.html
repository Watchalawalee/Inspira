<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nearby Bus Stops</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f7f9fb;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    .bus-container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

    .bus-stop {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
    }

    .bus-stop:last-child {
      border-bottom: none;
    }

    .bus-stop h3 {
      margin: 0;
      font-size: 1.1em;
      color: #1d3557;
    }

    .info {
      font-size: 0.95em;
      color: #444;
      margin-top: 4px;
    }

    .icon {
      margin-right: 4px;
    }

    .price {
      margin-top: 8px;
      font-size: 1.1em;
      color: #1d3557;
    }
    
    #map {
      height: 500px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      z-index: 0; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö */
    }

    #route-inputs {
      text-align: center;
      margin-bottom: 12px;
    }
    input, datalist, button {
      margin: 4px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      background-color: #1d3557;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }

    button:hover {
      background-color: #457b9d;
      transform: scale(1.02);
    }

    button:active {
      background-color: #0b2545;
      transform: scale(0.97);
    }


  </style>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARUJc-U7xfVvWsV4LnguUoIZQcvoRM2ik"></script>
</head>
<body>
  <button onclick="history.back()" style="margin-bottom: 16px; background-color: #1d3557; color: white; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer;">
    ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£
  </button>
  <div class="main-container" style="display: flex; gap: 20px; max-width: 1200px; margin: auto;">
    <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå -->
    <div class="left-panel" style="flex: 1;">
      <div class="bus-container">
        <h2>üöç Nearby Bus Stops</h2>
        <div id="bus-list"></div>
      </div>
    </div>
  
    <!-- ‡∏Ç‡∏ß‡∏≤: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
    <div class="right-panel" style="flex: 1;">
      <div id="route-inputs">
        <input list="stop-suggestions" id="startStopInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
        <datalist id="stop-suggestions"></datalist>
        <button onclick="useMyLocation()">üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button onclick="suggestRoutes()">üß≠ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
      </div>

      <div id="route-results" style="margin-top: 20px; padding: 12px; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); max-width: 600px; margin-inline: auto;">
        <h3 style="margin-bottom: 8px;">üöç Suggested Routes</h3>
        <div id="routes-display">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
      </div>      
      
      <h2 style="text-align:center;">üó∫Ô∏è Map</h2>
      <div id="map" style="width: 100%; height: 500px; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);"></div>
    </div>
  </div>
  

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const exhibitionId = urlParams.get('id');
  
    let map;
    let busMarkers = [];
    let exhibitionMarker;  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£

    function initMap(centerLat, centerLng, stops = []) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: centerLat, lng: centerLng },
        zoom: 15,
      });

      exhibitionMarker = new google.maps.Marker({
        position: { lat: centerLat, lng: centerLng },
        map: map,
        icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        title: "üìç Exhibition Location"
      });

      stops.forEach((stop, index) => {
        if (stop.latitude && stop.longitude) {
          const marker = new google.maps.Marker({
            position: { lat: stop.latitude, lng: stop.longitude },
            map: map,
            icon: "https://maps.google.com/mapfiles/ms/icons/bus.png",
            title: stop.stop_name,
          });

          const infoWindow = new google.maps.InfoWindow({
            content: `<strong>${stop.stop_name}</strong><br>Distance: ${stop.distance} m`
          });

          marker.addListener("click", () => infoWindow.open(map, marker));
          busMarkers.push({ marker, infoWindow });
        }
      });
    }

    // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    Promise.all([
      fetch(`http://localhost:5000/exhibitions/${exhibitionId}/nearby-bus`).then(res => res.json()),
      fetch(`http://localhost:5000/exhibitions/${exhibitionId}`).then(res => res.json())
    ])
    .then(([busStops, ex]) => {
      const container = document.getElementById('bus-list');
      container.innerHTML = '';

      if (!Array.isArray(busStops)) {
        throw new Error("Invalid busStops format");
      }

      const filteredStops = busStops.filter(stop =>
        stop.routes && stop.routes.length > 0 &&
        stop.min_price !== undefined && stop.max_price !== undefined
      );

      if (ex.latitude && ex.longitude) {
        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
        initMap(ex.latitude, ex.longitude, filteredStops);
      }

      exhibitionLatLng = { lat: ex.latitude, lng: ex.longitude };

      if (filteredStops.length === 0) {
        container.innerHTML = '<p>üö´ No nearby bus stops found.</p>';
        return;
      }

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≤‡∏¢
      filteredStops.slice(0, 10).forEach((stop, index) => {
        const div = document.createElement('div');
        div.className = 'bus-stop';
        div.setAttribute('data-stop-id', stop.stop_id);
        const icon = getTransportIcon(stop.stop_name); 

        const routeList = Array.isArray(stop.routes)
          ? Array.from(new Map(
              stop.routes.map(route => {
                const key = `${route.short_name}-${route.long_name}`;
                return [key, route]; // ‡πÉ‡∏ä‡πâ Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏ã‡πâ‡∏≥
              })
            ).values()).map(route => {
              const shortName = route?.short_name || 'N/A';
              const longName = route?.long_name || '';
              const full = `${longName}`;
              const onlyThai = full.split(/;|,|\(/)[0].trim();
              return `<li class="ml-4 list-disc"><strong>‡∏™‡∏≤‡∏¢ ${shortName}</strong> - ${onlyThai}</li>`;
            }).join('')
          : '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</li>';



        let price;
        if (typeof stop.min_price === 'number' && typeof stop.max_price === 'number') {
          if (stop.min_price === 0 && stop.max_price === 0) {
            price = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          } else if (stop.min_price === stop.max_price) {
            price = `${stop.min_price} Baht`;
          } else {
            price = `${stop.min_price} - ${stop.max_price} Baht`;
          }
        } else {
          price = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        }

        div.innerHTML = `
         <h3><strong>üÖøÔ∏è ${index + 1}.</strong> ${icon} ${stop.stop_name}</h3>
          <div class="info"><span class="icon">üìè</span>Distance: <strong>${stop.distance}</strong> meters</div>
          <div class="info"><span class="icon">${icon}</span>Routes:</div>
          <ul class="mt-1">${routeList}</ul>
          <div class="price">Fare: <strong>${price}</strong></div>
        `;

        container.appendChild(div);
      });
    })


    .catch(err => {
      console.error('Error loading data:', err);
      document.getElementById('bus-list').innerHTML = '<p>‚ùå Failed to load bus stop data.</p>';
    });

    let allStops = []; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete
    let exhibitionLatLng = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete)
    fetch('http://localhost:5000/bus-routes/all-stops')
      .then(res => res.json())
      .then(data => {
        allStops = data;

        const datalist = document.getElementById('stop-suggestions');
        datalist.innerHTML = data.map(stop =>
          `<option value="${stop.stop_name}"></option>`
        ).join('');
      });


    function useMyLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById('startStopInput').value = `@${pos.coords.latitude},${pos.coords.longitude}`;
      }, err => {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ');
      });
    }

    function displayRoutes(data) {
      const resultContainer = document.getElementById('routes-display');

      if (!Array.isArray(data) || data.length === 0) {
        resultContainer.innerHTML = `<p style="color:red;">${data?.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á'}</p>`;
        return;
      }

      // üîÑ ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° get_on ‡πÅ‡∏•‡∏∞ get_off
      const grouped = {};
      data.forEach(route => {
        const key = `${route.get_on}___${route.get_off}`;
        if (!grouped[key]) {
          grouped[key] = {
            get_on: route.get_on,
            get_off: route.get_off,
            get_off_distance: route.get_off_distance,
            routes: []
          };
        }
        if (Array.isArray(route.routes)) {
          grouped[key].routes.push(...route.routes);
        } else if (route.route) {
          grouped[key].routes.push(route.route); // fallback ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        } else {
          grouped[key].routes.push(null); // ‡πÉ‡∏™‡πà null ‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        }

      });

      const html = Object.values(grouped).map((group, i) => {
        // üîΩ ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏ã‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô render
        const uniqueRoutes = Array.from(
          new Map(group.routes.map(r => [`${r?.short_name}-${r?.long_name}`, r])).values()
        );

        return `
          <div style="margin-bottom: 12px; padding: 10px; background: #f1f5f9; border-radius: 8px;">
            <div><strong>üìç ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> ${group.get_on}</div>
            <div><strong>üéØ ‡∏•‡∏á‡∏ó‡∏µ‡πà:</strong> ${group.get_off} <small>(‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${group.get_off_distance} ‡πÄ‡∏°‡∏ï‡∏£)</small></div>
            <div><strong>üöå ‡∏™‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ:</strong></div>
            <ul class="ml-4 list-disc">
              ${uniqueRoutes.map(r => {
                if (!r) return `<li>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</li>`;

                const shortName = r.short_name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                const longName = r.long_name || '';
                const onlyThai = longName.split(/;|,|\(/)[0]?.trim() || ''; // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô undefined

                return `<li><strong>‡∏™‡∏≤‡∏¢ ${shortName}</strong> - ${onlyThai}</li>`;
              }).join('')}
            </ul>
          </div>
        `;
      }).join('');



      resultContainer.innerHTML = html;
    }



    function suggestRoutes() {
      const input = document.getElementById('startStopInput').value.trim();
      const resultContainer = document.getElementById('routes-display');

      if (!exhibitionLatLng) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£');
        return;
      }

      if (input.startsWith('@')) {
        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î
        const parts = input.slice(1).split(',');
        if (parts.length !== 2) {
          resultContainer.innerHTML = `<p style="color:red;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>`;
          return;
        }
        const [lat, lng] = parts.map(parseFloat);

        const url = `http://localhost:5000/bus-routes/suggest-route?lat=${lat}&lng=${lng}&exLat=${exhibitionLatLng.lat}&exLng=${exhibitionLatLng.lng}`;
        fetch(url)
          .then(res => res.json())
          .then(displayRoutes)
          .catch(err => {
            console.error(err);
            resultContainer.innerHTML = `<p style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</p>`;
          });

      } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢ ‚Üí ‡∏´‡∏≤ stop_id ‡∏à‡∏≤‡∏Å allStops ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const matchedStop = allStops.find(stop => stop.stop_name === input);

        if (!matchedStop) {
          resultContainer.innerHTML = `<p style="color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>`;
          return;
        }

        // ‡∏™‡πà‡∏á stop_id ‡πÑ‡∏õ backend
        fetch(`http://localhost:5000/bus-routes/suggest-route?exLat=${exhibitionLatLng.lat}&exLng=${exhibitionLatLng.lng}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userStops: [matchedStop.stop_id] })
        })
          .then(res => res.json())
          .then(displayRoutes)
          .catch(err => {
            console.error(err);
            resultContainer.innerHTML = `<p style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</p>`;
          });
      }
    }

    function formatRouteName(fullName) {
      if (!fullName) return '';
      // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏≠‡∏≠‡∏Å (‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ ";" ‡∏´‡∏£‡∏∑‡∏≠ "(" ‡∏Ñ‡∏±‡πà‡∏ô‡πÑ‡∏ß‡πâ)
      return fullName.split(/;|\(/)[0].trim();
    }

    function getTransportIcon(name) {
      const thaiNameOnly = name.split(/;|,/)[0].trim();

      if (/BTS|MRT|ARL|SRT|BRT/.test(thaiNameOnly)) return 'üöÜ';
      if (/‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠/.test(thaiNameOnly)) return '‚õ¥Ô∏è';
      return 'üöå';
    }


    function getRouteFare(name) {
      if (/BTS|MRT|ARL|SRT|BRT/.test(name)) return 30;
      if (/‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠/.test(name)) return 20;
      return 25;
    }

  </script>
  
</body>
</html>
