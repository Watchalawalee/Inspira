<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Forgot Password</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label, input, button { margin: 6px 0; display: block; }
    #passwordSection { display: none; }
    #pinSentMessage { color: green; font-size: 0.9rem; margin-top: 4px; }
    #result { color: green; }
    #error { color: red; }
  </style>
</head>
<body>
  <h2>üîí ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>

  <!-- Email -->
  <label>Email:
    <input type="email" id="email" required />
  </label>
  <button onclick="sendPIN()">üì© ‡∏™‡πà‡∏á PIN</button>
  <div id="pinSentMessage"></div>

  <!-- PIN -->
  <form id="pinForm">
    <label>PIN ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•:
      <input type="text" id="pin" maxlength="6" required />
    </label>
    <button type="submit">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PIN</button>
  </form>

  <!-- ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
  <div id="passwordSection">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:
      <input type="password" id="newPassword" />
    </label>
    <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:
      <input type="password" id="confirmPassword" />
    </label>
    <button onclick="resetPassword()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
  </div>

  <p id="result"></p>
  <p id="error"></p>

  <script>
    let verifiedEmail = '';
    let verifiedPIN = '';

    async function sendPIN() {
      const email = document.getElementById('email').value.trim();
      if (!email) return showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•');

      try {
        const res = await fetch('http://localhost:5000/auth/request-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('pinSentMessage').textContent = 'üì© ‡∏™‡πà‡∏á PIN ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
          document.getElementById('error').textContent = '';
        } else {
          showError(data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á PIN');
        }
      } catch (err) {
        showError('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      }
    }

    document.getElementById('pinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pin = document.getElementById('pin').value.trim();

      if (!email || !pin) return showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞ PIN');

      try {
        const res = await fetch('http://localhost:5000/auth/confirm-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, pin, newPassword: '__dummy__' })
        });

        const data = await res.json();
        console.log('[DEBUG] PIN Check Response:', data);

        if (res.ok && data.verified) {
          showMessage('‚úÖ PIN ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà');
          document.getElementById('passwordSection').style.display = 'block';
          verifiedEmail = email;
          verifiedPIN = pin;
        } else {
          showError(data.message || 'PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

      } catch (err) {
        showError('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      }
    });

    async function resetPassword() {
      const newPass = document.getElementById('newPassword').value.trim();
      const confirmPass = document.getElementById('confirmPassword').value.trim();

      if (!newPass || !confirmPass) return showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á');
      if (newPass !== confirmPass) return showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');

      try {
        const res = await fetch('http://localhost:5000/auth/confirm-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: verifiedEmail,
            pin: verifiedPIN,
            newPassword: newPass
          })
        });

        const data = await res.json();

        if (res.ok) {
          showMessage('üéâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
          document.getElementById('passwordSection').innerHTML = '';
        } else {
          showError(data.message || data.error);
        }
      } catch (err) {
        showError('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      }
    }

    function showMessage(msg) {
      document.getElementById('result').textContent = msg;
      document.getElementById('error').textContent = '';
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
      document.getElementById('result').textContent = '';
    }
  </script>
</body>
</html>
